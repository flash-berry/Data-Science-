---
title: "Pyshnii_DZ5"
author: "Artem Pyshnii Alexsandrovich"
date: "2025-04-14"
output: html_document
---

Загружаем датасет о страховых выплатах семьям.
```{r}
library(readr)
df <- read_csv("C:/Users/User/Desktop/Data Science/insurance.csv")
```

Датасет состоит из следующих признаков:

1) Age - возраст страхователя.

2) Sex - пол страхователя.

3) BMI - индекс массы тела, дающий представление о фигуре, относительно высоком или низком весе по отношению к росту, объективный показатель массы тела (кг/м2), использующий соотношение роста и веса, в идеале 18,5 до 24,9.

4) Children - количество детей, на которых распространяется медицинская страховка/количество иждивенцев.

5) Smoker - курение.

6) Region - район проживания страхователя в США: северо-восток, юго-восток, юго-запад, северо-запад.

7) Charges - индивидуальные медицинские расходы, оплачиваемы медицинской страховкой.

Для описанного датасета предлагается построить модель линейной регрессии, где Charges - целевая переменная, а остальные переменные предикаторы.

```{r}
library(dplyr)
glimpse(df)
```

```{r}
summary(df)
```
Преобразуем категориальные признаки в факторные, чтобы они автоматические преобразовывались при вызове функции линейной регрессии.
```{r}
df$region <- factor(df$region)
df$sex    <- factor(df$sex)
df$smoker <- factor(df$smoker)
```

```{r}
library(ggplot2)
ggplot(data=df, aes(x=charges)) + 
  geom_histogram(colour="purple", # Make the borders purple
                 fill="yellow", # Make the fill of the bars yellow
                 alpha=0.5, # Make the fill see through 50%
                 linetype="dashed", # Make the borders dashed
                 size=0.5 # Make the size of the borders smaller
  )
```

На гистограмме целевого признака можно заметить тяжёлый правый хвост. Прологарифмируем целевой признак, чтобы приблизить его к нормальному распределению.

```{r}
df$log_charges <- log(df$charges)
glimpse(df)
```

```{r}
ggplot(data=df, aes(x=log_charges)) + 
  geom_histogram(colour="purple", # Make the borders purple
                 fill="yellow", # Make the fill of the bars yellow
                 alpha=0.5, # Make the fill see through 50%
                 linetype="dashed", # Make the borders dashed
                 size=0.5 # Make the size of the borders smaller
  )
```
Построим модель линейной регрессии, которая будет предсказывать целевой признак Charges, а остальные признаки из набора данных будут предикаторами.
```{r}
model <- lm(log_charges ~ age + sex + bmi + children + smoker + region, data = df)
```

```{r}
summary(model)
```
Коэффициент детерминации = 0.7679 - это значит, что построенная модель хорошо объясняет вариацию данных.
Значение F-статистики 549.8 и p-value < 2.2e-16 - это значит, что гипотеза о том, что все коэффециенты регрессии равны 0, отвергается, следовательно регрессия существует и модель статистически значима.
Показатель Regionnorthwest статистически не значим, его p-value = 0.067860

Построим график распределения остатков модели.
```{r}
hist(model$residuals)
```
```{r}
shapiro.test(model$residuals)
```
Внешне распределение остатков не похоже на нормальное и тест Шапиро подтверждает эту гипотезу, отклоняя нулевую гипотезу о нормальности, попадая в критическую область с p-value < 2.2e-16.

```{r}
plot(model)
```

**Анализ остатков регрессии** по четырем базовым пунктам

- **линейность взаимосвязи**. На графике Residuals vs Fitted множество выбросов и присутствуют две линии тренда. Таким образом предположение о линейности взаимосвязи ложно.

- **нормальность остатков регрессии**. На графике квантиль-квантиль хвосты отклоняются.

- **однородность дисперсии остатков**. 
```{r}
#один из базовых критериев для проверки на гомоскедастичность
car::ncvTest(model)
```
Значение p-value = 3.5034e-14 критерия проверки на гомоскедастичность и график Scale-Location отвергают гипотезу об однородности дисперсии остатков.

- **расстояние Кука**. На графике Residuals vs Leverage выбросами считаются те наблюдения, для которых расстояние Кука больше, чем 0.003 (4/n).

```{r}
#создадим индекс, который определяет соответствие наблюдения эпирическому правилу о выбросах
inx <- ifelse(cooks.distance(model) < 4/1338, "keep","delete")
n_deleted <- sum(inx == "delete")
n_deleted
```

```{r}
model_mod <- lm(log_charges ~ age + sex + bmi + children + smoker + region, data=df[inx=='keep',])
summary(model_mod)
```
Удаление выбросов по критерию растояния Кука, значительно улучшает показатель детерминации до 0.9096.
При этом удаляется 102 выброса.

Чтобы интерпретировать коэффициенты регрессии их сначала нужно преобразовать из логарифмической шкалы в линейную.
```{r}
coef_interpretation <- exp(coef(model_mod)) - 1 
coef_interpretation
```
Если значение Age изменится на 1, то значение Charges изменится на 0.041499635 (чем старше страхователь, тем больше он платит).
Если значение Sexmale изменится на 1, то значение Charges изменится на -0.087344650 (мужчины платят меньше женщин).
Если значение BMI изменится на 1, то значение Charges изменится на 0.009462752 (чем выше индекс массы тела страхователя, тем больше он платит).
Если значение Children изменится на 1, то значение Charges изменится на 0.119240833 (чем больше у страхователя детей, тем больше он платит).
Если значение Smokeryes изменится на 1, то значение Charges изменится на 3.956232437 (курящие страхователи гораздо больше платят, чем некурящие).



